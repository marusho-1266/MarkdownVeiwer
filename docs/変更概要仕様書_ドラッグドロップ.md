# 変更概要仕様書：ローカルMDファイルのドラッグ＆ドロップ対応

| 項目 | 内容 |
|------|------|
| ドキュメントID | MDV-DD-001 |
| 作成日 | 2026-02-06 |
| 対象機能 | ローカルMarkdownファイルのドラッグ＆ドロップ読み込み |
| 対象ファイル | `index.html` |

---

## 1. 変更の目的

- ユーザーがローカルに保存した `.md` ファイルを、エクスプローラー等からブラウザ上にドラッグ＆ドロップするだけで、左側のテキストエリアにその内容を展開できるようにする。
- キーボード入力やコピー＆ペーストに頼らず、ファイルを「放り込む」だけで編集開始できる操作系を追加し、利用性を向上させる。

---

## 2. 対象範囲

| 区分 | 対象 |
|------|------|
| 変更対象 | 本システムのフロントエンド（単一HTMLアプリケーション） |
| 変更ファイル | `index.html`（HTML・CSS・JavaScript の追加・修正） |
| 非対象 | サーバー側処理、バックエンドAPI、既存の印刷・プレビュー・テーマ・Mermaid 等の他機能の仕様変更 |

---

## 3. 変更内容の概要

- **追加する挙動**  
  ブラウザ上の所定の領域（入力エリアまたはテキストエリア周辺）に、ローカルのテキストファイル（主に `.md`）をドラッグ＆ドロップしたときに、そのファイル内容を読み取り、左側のテキストエリア（`#markdown-input`）に表示する。
- **既存機能との関係**  
  既存の「テキストエリアへの入力 → 右側プレビュー更新」の流れはそのまま利用する。ドロップ時も同じ `input` イベントを発火させ、プレビュー・行番号・Mermaid 等が既存どおり更新されるようにする。

---

## 4. 機能仕様

### 4.1 ドロップ受付領域

- **候補**  
  - 案A: 左側の入力エリア全体（`#input-area`）をドロップ対象とする。  
  - 案B: テキストエリアを含むエディタラッパー（`.editor-wrapper`）をドロップ対象とする。  
- **推奨**  
  入力エリア全体（案A）とし、テキストエリア外の余白にドロップしても読み込まれるようにする。必要に応じて、後から案Bに変更可能とする。

### 4.2 対象ファイル

- **拡張子**  
  - 主対象: `.md`, `.markdown`  
  - 任意: その他のテキストファイル（`.txt` 等）も受け付けるかは実装時に決定（受け付ける場合、ドロップ時に「テキストファイル」として扱う）。
- **複数ファイル**  
  - 複数ファイルが同時にドロップされた場合は、先頭の1ファイルのみを対象とする（または「複数ファイルは非対応」と明示し、1ファイルのみ処理する）。

### 4.3 動作フロー

1. ユーザーがローカルファイルをドロップ対象領域にドラッグして重ねる（`dragover`）。
2. ブラウザの既定のドラッグ挙動を抑制し、ドロップ可能であることを示す（必要に応じて視覚的フィードバックを付与）。
3. ユーザーがドロップする（`drop`）。
4. `DataTransfer.files` からファイルを取得し、テキストとして読み取る。文字コードは **4.6 文字コードの扱い（BOM 優先・読み直し）** に従い、BOM があればそれを優先し、BOM がなく U+FFFD が含まれる場合のみ Shift_JIS で読み直す（確認なし）。
5. 読み取った文字列を `#markdown-input` の `value` に設定する。
6. `input` イベントを発火させ、既存のプレビュー更新・行番号更新・Mermaid レンダリングが行われるようにする。

### 4.6 文字コードの扱い（BOM 優先・読み直し）

- **方針**  
  ドロップ時は **BOM（UTF-8 の EF BB BF）を最優先** し、BOM がある場合は UTF-8 として解釈し、再読みは行わない。BOM がなく、UTF-8 としてデコードした結果に **U+FFFD** が含まれる場合に限り、同一ファイルを `FileReader.readAsText(file, 'Shift_JIS')` で読み直す（ユーザー確認は行わない）。

- **手順**  
  1. ファイルを `FileReader.readAsArrayBuffer(file)` でバイト列として読み、先頭 3 バイトが **UTF-8 BOM（0xEF, 0xBB, 0xBF）** かどうかを確認する。  
  2. BOM がある場合: 3 バイト目以降を UTF-8 としてデコードし、その結果を採用する（再読みは行わない）。  
  3. BOM がない場合: バイト列全体を UTF-8 としてデコードする。  
  4. デコード結果に **U+FFFD（replacement 文字）** が含まれる場合: 同一ファイルを `readAsText(file, 'Shift_JIS')` で再度読み、得られた文字列を採用する。  
  5. U+FFFD が含まれない場合は、UTF-8 で解釈した結果をそのまま採用する（再読みは行わない）。

- **補足**  
  - BOM がある場合はエンコーディングが明確なため、その指示に従い自動切り替えは行わない。これにより、BOM 付き UTF-8 に U+FFFD が含まれていても誤って Shift_JIS で読み直すことを防ぐ。  
  - BOM がなく U+FFFD が出た場合のみ読み直すため、テンポを損なわない。

### 4.4 エラー・例外

- **非テキストファイル**  
  - 画像や PDF 等、テキストとして読めないファイルがドロップされた場合は、読み取りを試みず、必要に応じて簡易メッセージ（例: アラートやトースト）で「テキストまたはMarkdownファイルをドロップしてください」と案内する。
- **読み取り失敗**  
  - `FileReader` の `error` 時は、ユーザーに「ファイルを読み込めませんでした」等のメッセージを表示する（実装方針でアラート／トーストのいずれかを選択）。

### 4.5 既存編集内容との関係

- ドロップ時に、**現在のテキストエリアの内容を、ドロップしたファイルの内容で上書きする**仕様とする。  
- 「カーソル位置に挿入する」「別タブで開く」等は本変更の範囲外とする（将来拡張で検討可能）。

---

## 5. 非機能要件（概要）

| 項目 | 内容 |
|------|------|
| ブラウザ | HTML5 Drag and Drop API および File API をサポートするモダンブラウザ（現行の Chrome / Edge / Firefox / Safari 等）。既存の「対応ブラウザ」と同等を想定。 |
| セキュリティ | ユーザーが明示的にドロップしたファイルのみを読み取る。サーバーへファイルを送信しない。既存と同様にクライアント内完結。 |
| パフォーマンス | 大きなファイル（例: 数MB）をドロップした場合、`readAsText` が同期的にブロックしないよう、既存の非同期パターンで処理する。 |
| アクセシビリティ | ドロップ領域に `aria-label` 等を付与し、キーボードやスクリーンリーダー利用者向けの説明を追加することを検討する。 |

---

## 6. 影響範囲

- **既存機能**  
  - テキストエリアの入力・プレビュー・印刷・テーマ・Mermaid・行番号・スクロール連動・コンテキストメニューは、すべて変更なしで利用可能であること。ドロップ時は「プログラムから `value` を設定し `input` を発火させる」だけに留める。
- **デプロイ・ビルド**  
  - 単一HTMLの修正のみであり、ビルド手順・デプロイ手順の変更は不要。
- **ドキュメント**  
  - README の「使い方」に「ローカルMDファイルを左側エリアにドラッグ＆ドロップすると内容を読み込めます」といった一文を追加することを推奨する。

---

## 7. 制約・注意事項

- 本機能は**ローカルで開いたファイル**（`file://` またはローカルサーバーで配信したページ）および、**HTTPS で配信したページ**のいずれでも、ブラウザのセキュリティポリシー上、ユーザーがドロップしたファイルの読み取りは可能である。
- ドラッグ＆ドロップはユーザー操作に起因するため、自動でファイルを読み込むような挙動は行わない。
- ファイル名やパスは、現仕様ではテキストエリアには反映しない（タイトル表示等は将来拡張で検討）。

---

## 8. 受け入れ条件（概要）

- ローカルの `.md` ファイル（および仕様で定めた他のテキストファイル）を、指定したドロップ領域にドロップすると、その内容が左側テキストエリアに表示されること。
- UTF-8 および Shift_JIS（SJIS）で保存されたファイルをドロップした場合、文字化けせずに表示されること（4.6 の BOM 優先・読み直しに従うこと）。
- ドロップ後、右側プレビュー・行番号・Mermaid が既存どおり更新されること。
- 非テキストファイルや読み取り失敗時に、仕様で定めたとおりエラー案内が行われること。
- 既存の入力・印刷・テーマ・リサイズ等の操作に支障がないこと。

---

以上、変更概要仕様書とする。
